

# 客户端分库分表系列（水平分表方案）

张帅   qq 785266428     有问题随时讨论

> 分库分表主要解决高并发和海量数据对数据库的冲击问题。通常分为垂直拆分和水平拆分。
>
> 垂直拆分是根据业务将一个库（表）拆分为多个库（表）。由于它与业务关系密切，因此需要根据具体业务定制化方案。
>
> 水平拆分是根据分片算法将一个库（表）拆分为多个库（表）。水平拆分分为分库和分表。
>
> 分库可以解决高并发导致响应变慢的问题。
>
> 分表可以解决海量数据导致检索变慢的问题。

分库分表系列文章将基于以下问题，逐一讲述水平分表、垂直分表和分库。本文讲述水平分表。

* 解决的核心问题
* 实现方案
* 优缺点
* 适用场景

[TOC]

## 水平分表解决的核心问题

关系型数据库在大于一定数据量的情况下检索性能会急剧下降。在面对互联网海量数据情况时，所有数据都存于一张表，显然会轻易超过数据库表可承受的数据量阈值。

水平分表可以将每张表的数据量降到理想数值，从而控制检索性能在可接受的范围内。

## 水平分表实现方案

水平拆分是通过分片算法实现将一个（库）表拆分成多个（库）表。

任何分片算法需要input和output，input用于分片的参数，output分片结果。分片参数可以是一个或多个字段，但必须能得到唯一的output，从而保证分片结果的唯一性。

水平分表方案主要区别在于分片参数和分片算法，但所有方案都必须考虑分表后各分表中数据的平衡性、分表结果的业务兼容性、分表的扩展性和适用场景。

以下是常见的水平分表方案。

### 1. 取模分片（包括字符串hash后取模）

取模分片是利用分片参数（m）对特定的分表数（n）做模运算得到分表（k），即k=m%n。

* 分表平衡性

其中n是确定值，k主要取决于m，**要保证k的平均分布，只要保证m的平均分布**即可。其中m可以进行取模运算，必须是数值。

* 业务兼容性

业务兼容性决定了m的取值。m必须满足业务的检索需求。

**兼容方案（查询字段冗余分表信息）**

用户相关的记录一般都以用户ID作为m值，这样可以满足用户视角的查询。当以用户ID分表的数据需要以非用户视角查询时，就需要该查询参数中包含分表信息。

例：订单表（deals）,以userId分表，可以方便的检索用户的订单信息，但是如果客户只提供订单号查询订单信息时，由于没法确定分表，因此直接查出订单详情比较困难。面对这种情况，就可以将分表信息冗余在订单ID中，根据订单ID即可知道分表信息。

* 分表扩展性

业务系统运行中，数据积累逐渐增加，当预先分表不能满足需求时，就需要对已有分表扩容。

**扩容方案一    （停服方案  由x表扩容到y个表）**

（1）站点挂一个公告“为了为广大用户提供更好的服务，本站点将在今晚00:00-2:00之间升级，届时将不能登录，用户周知”

（2）停服务

（3）新建y个库，做好高可用

（4）数据迁移，重新分布，写一个数据迁移程序，从A库x张表里导入到B库y张表里，路由规则由%x升级为%y

（5）修改服务配置，包括修改路由规则，切换数据源等

（6）重启服务，连接新库重新对外提供服务

整个过程中，**最耗时的是第四步数据迁移**

**回滚方案**：

如果数据迁移失败，或者迁移后测试失败，则将配置改回A库，恢复服务，改天再挂公告。 

**方案优点**：简单

**方案缺点**：

（1）停服务，不高可用

（2）技术同学压力大，所有工作要在规定时间内做完，根据经验，压力越大约容易出错（这一点很致命）

（3）如果有问题第一时间没检查出来，启动了服务，运行一段时间后再发现有问题，难以回滚，需要回档，可能会丢失一部分数据

**扩容方案二  （2^x取模）**

方案一最耗时也最容易出错的是数据迁移，因此考虑扩容过程中如何避免数据迁移。这就是方案二，分表数n的取值为2的幂函数（n=2^x），从而决定了扩容需要成倍扩。

例：订单表deal目前分表为2张，分别是deal\_0和deal\_1，需要将其扩充到4张表，分别是deal\_0、deal\_1、deal\_2、deal\_3。

（1）创建表deal\_2，导入deal\_0已有数据，并实时同步表deal\_0数据；

​          创建表deal\_3，导入deal\_1已有数据，并实时同步表deal\_1数据；

（2）修改路由配置

​          由k=m%2，修改为k=m%4；

​	 修改后m%2=0的部分，映射为%4=0与%4=2；

​                     m%2=1的部分，映射为%4=1与%4=3；

这样修改可以保证拆分后依然能够路由到正确的数据。

 （3）reload配置

​	服务层reload配置有以下两种方式：

​	a）比较原始的，重启服务，读新的配置文件

​	b）高级一点的，配置中心给服务发信号，重读配置文件，重新初始化数据库连接池

​	不管哪种方式，reload之后，数据库的**实例扩容就完成了**，原来是2张表提供服务，现在变为4张表提供服务，这个过程一般可以在秒级完成，**对服务的正确性和可用性完全没有影响**。

**疑问：**

> a）切换过程中，m%2寻库和m%4寻库同时存在，是否有影响？

步骤（1）中建立了表数据之间的同步，此时仍然有效，因此不会产生影响。

> b）完成了表扩容，会发现每个数据库的数据量依然没有下降？

首先，可以确认的是新数据能够被平滑的分配到4张表了，新数据实现了扩容；其次，服务运行稳定后，可以做数据收缩，也就是步骤（4）。

（4）数据收缩

​	a)停止数据同步；

​	b)按照新的分片算法m%4清理库中分片错误数据；

这样下来，**每个库的数据量就降为原来的一半**，**数据收缩完成**。

**疑问：**

> a)如果有数据冗余了分表信息，例如以userId分表的记录中dealId冗余了分表信息，该怎么处理？

由dealId路由到表的逻辑需要加入（2）中映射关系。假设扩容次数是x，那么需要的最多检索次数y=2^x。由于扩容在业务系统中出现的次数比较少，因此扩容次数较少的情况还可以接受。**有更好的方案请大家分享**

* 适用场景（适用场景是相对的，是在同一场景下，相对较好的解决方案）

如手机号和账户映射表

a)需要全量数据，比如passport系统中手机号和账户映射关系

b)分片参数随机产生，无规律

### 2. 增量分片

增量分片是将分片参数m与分段规则比较得到分表k。分片参数m必须是递增数值。

* 分表平衡性

分表平衡性主要取决于分段规则。分段规则定义每个分段m起始值，**范围相等时，分表数据量绝对平衡**。但是没法确定每张表中用户的活跃度。

* 业务兼容性

增量分片的分片参数是递增的，具有全局唯一性，同时也具有全表唯一性，因此只能单条记录检索，不便于统计，排序等操作。即使在其它检索视角的字段加入分表信息，也只能利用该字段检索单条信息。

* 分表扩展性

扩展性非常好，根据数据量，随时可以修改分表规则，将新数据分配到扩展表。

例：user利用userId分表，userId是从1开始的递增数值。假设当前库中只有一张表user_0，userId已递增至50万，单表检索性能随数据量继续增加会下降到临界值，此时分表只需要做以下几步：

（1）新建表user_1

（2）修改分表规则：userId0-50万，映射到user\_0

​                                     userId>50万，映射到user\_1

（3）reload分表策略

* 适用场景

如账户表

a）分表参数递增

b）单条检索

c）无法预估数据量

### 3. 时间分片

时间分片要求分片参数m中含有时间信息，利用m中的时间信息与时间分段规则比较得到分表k。分片参数m必须包含时间信息。

- 分表平衡性

分表平衡性主要取决于分段规则。分段规则定义了时间起始值，一般定义相等的时间段，方便按时间检索。相等的时间段内，由于业务的随机性，在每个时间段的数据量会有差异，因此，平衡性只能控制在一定的阈值内。

- 业务兼容性

时间分片的分片参数包含时间信息，因此支持该时间段内的所有方式的检索。跨时间段的数据只能支持简单检索。

* 分表扩展性

扩展性类似增量分片，区别在于它是根据数据量，修改分表时间规则，将新数据分配到扩展表。

例：deal利用dealId分表，dealId中包含时间信息。假设20170223日，当前库中只有一张表deal_0。表中数据已递增至50万，单表检索性能随数据量继续增加会下降到临界值，此时分表只需要做以下几步：

（1）新建表deal_1

（2）修改分表规则：time<=20170223，映射到deal\_0

​                                     dealId>20170223，映射到deal\_1

（3）reload分表策略

- 适用场景

如订单表

a）分表参数含有时间参数

b）业务场景可以按时间划分

c）无法预估数据量

## 水平分表优缺点

* 优点

解决了单表数据量增加导致的检索效率下降问题；

事务在一个库中完成，不涉及分布式事务；

具有良好的分表扩展性；

针对不同的业务模型有灵活的实现方案；

* 缺点

数据量无限大，单库存在物理极限；

高并发存在单库访问限制；

## 水平分表适用场景

水平分表解决的核心问题是海量数据导致的单表检索效率下降的问题，但是存在高并发访问限制和单库物理限制，因此适用于以下场景：

1. 单表数据量过大，需要分散单表压力；
2. 单库可以承担全部数据量和并发量；



本片文章只讲述了水平分表，没有涉及水平分库。水平分库会产生分布式事务问题，同在一个库则不需考虑分布式事务。目前强一致性的分布式事务由于性能问题，导致使用起来并不一定比不分库分表快，因此解决方案中采用最终一致性的柔性事务居多。另外过多的数据库实例也不利于运维管理。

**综上所述，在分表就可以解决问题的情况下，应该善于使用同库不同表可有效避免分布式事务带来的麻烦。**



文章写得比较简单，我会不断改正，完善。

【希望】

1. 文章中提到的方案有误之处，请多多指出；
2. 希望技术大咖将自己经历过得方案分享出来，并加入其中；
3. 希望感兴趣的同学可以一起学习，一起完善；

